{% extends 'base.html' %}

{% block content %}
<h2 style="text-align:center; margin-bottom: 12px; font-size: 1.3em;">SELEZIONA I POSTI</h2>

<div>
  <form method="post" id="seats-form" style="display: flex; width: 100%;">
    <!-- Colonna 1: Piantina -->
    <div class="booking-col booking-main">
      <h3 style="text-align:center; margin-bottom: 6px; font-size: 1.1em;">PALCOSCENICO</h3>
      <div class="seatmap-wrapper">
        <div class="seatmap">
          {% for row_letter in row_letters %}
          {% if loop.index0 == 7 %}
          <div class="seatmap-corridor-horizontal"></div>
          {% endif %}
          <div class="seat-row">
            {% for col in range(1, cols+1)|reverse %}
            {% if col == 14 %}
            <span class="seatmap-corridor-vertical"></span>
            {% endif %}
            {% set seat = row_letter ~ col %}
            {% if seat in unavailable %}
            <!-- Non mostrare il posto -->
            {% elif seat in booked_seats %}
            <span class="seat booked" title="{{ seat }}"></span>
            {% else %}
            <label class="seat" title="{{ seat }}">
              <input type="checkbox" name="seats" value="{{ seat }}" onchange="updateSelectedSeats()">

            </label>
            {% endif %}
            {% endfor %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Colonna 2: Info evento, stato, legenda, form -->
    <div class="booking-col booking-side">
      <h3 style="text-align:center; margin-bottom: 6px; font-size: 1em;">{{ event.title }}</h3>
      <div style="color:#555; margin-bottom:5px; text-align:center; font-size: 0.85em;">{{ event.date }}</div>
      <div style="color:#555; margin-bottom:5px; text-align:center; font-size: 0.85em;">{{ event.time }}</div>
      {% if event.poster_url %}
      <img src="{{ event.poster_url }}" alt="Locandina evento" class="event-poster">
      {% else %}
      <div class="event-poster-placeholder">Nessuna locandina</div>
      {% endif %}
      <div id="selected-seats" class="selected-seats-box">
        Nessun posto selezionato.
      </div>
      <div class="form-group" style="margin-bottom: 9px;">
        <label for="name" style="font-size: 0.9em; margin-bottom: 3px;"><b>Nome:</b></label>
        <input type="text" id="name" name="name" required style="padding: 6px 8px; font-size: 0.9em;">
      </div>
      <div class="form-group" style="margin-bottom: 9px;">
        <label for="email" style="font-size: 0.9em; margin-bottom: 3px;"><b>Email:</b></label>
        <input type="email" id="email" name="email" required style="padding: 6px 8px; font-size: 0.9em;">
      </div>
      <div class="total-box">
        Totale: <span id="total-price">0</span> â‚¬
      </div>
      <button type="submit" class="btn-book">Acquista</button>
    </div>
  </form>
</div>


<script>
  const MAX_SEATS = 10;

  function updateSelectedSeats() {
    const checked = Array.from(document.querySelectorAll('input[name="seats"]:checked'));
    const div = document.getElementById('selected-seats');
    const totalSpan = document.getElementById('total-price');
    const submitButton = document.querySelector('.btn-book');
    const price = {{ event.price|default (0)
  }};

  if (checked.length === 0) {
    div.textContent = "Nessun posto selezionato.";
    totalSpan.textContent = "0";
    submitButton.disabled = true;
  } else if (checked.length > MAX_SEATS) {
    // Deseleziona l'ultimo posto selezionato se supera il limite
    const lastChecked = checked[checked.length - 1];
    lastChecked.checked = false;
    updateSelectedSeats(); // Richiama la funzione per aggiornare
    return;
  } else {
    div.innerHTML = `Posti selezionati (${checked.length}/${MAX_SEATS}): ` + checked.map(cb => cb.value).join(', ');
    totalSpan.textContent = (checked.length * price).toFixed(2);
    submitButton.disabled = false;
  }

  // Aggiorna la grafica dei posti selezionati
  document.querySelectorAll('.seat').forEach(label => {
    label.classList.remove('selected');
  });
  checked.forEach(cb => {
    cb.parentElement.classList.add('selected');
  });

  // Disabilita i posti rimanenti se si raggiunge il limite
  const allSeats = document.querySelectorAll('input[name="seats"]');
  allSeats.forEach(seat => {
    if (!seat.checked && checked.length >= MAX_SEATS) {
      seat.disabled = true;
      seat.parentElement.style.opacity = '0.5';
      seat.parentElement.style.cursor = 'not-allowed';
    } else if (!seat.checked) {
      seat.disabled = false;
      seat.parentElement.style.opacity = '1';
      seat.parentElement.style.cursor = 'pointer';
    }
  });
  }

  document.addEventListener('DOMContentLoaded', function () {
    updateSelectedSeats();
    // Aggiungi messaggio informativo
    const selectedSeatsDiv = document.getElementById('selected-seats');
    const infoMessage = document.createElement('div');
    infoMessage.style.cssText = 'font-size: 0.9em; color: #666; margin-top: 8px; text-align: center;';
    infoMessage.textContent = `Massimo ${MAX_SEATS} posti per acquisto`;
    selectedSeatsDiv.parentElement.insertBefore(infoMessage, selectedSeatsDiv.nextSibling);

    // Gestione scroll orizzontale su mobile
    const seatmapWrapper = document.querySelector('.seatmap-wrapper');
    if (seatmapWrapper && window.innerWidth <= 480) {
      let hasScrolled = false;

      seatmapWrapper.addEventListener('scroll', function () {
        if (!hasScrolled && this.scrollLeft > 10) {
          hasScrolled = true;
          this.classList.add('scrolled');
        }
      });

      // Aggiunge touch feedback per scroll
      seatmapWrapper.addEventListener('touchstart', function () {
        this.style.transition = 'none';
      });

      seatmapWrapper.addEventListener('touchend', function () {
        this.style.transition = 'transform 0.3s ease';
      });
    }
  });
</script>
{% endblock %}